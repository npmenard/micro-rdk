name: publish

on:
  push:
    tags:
      - "*"

jobs:
  tests:
    uses: ./.github/workflows/test.yml
  publish-release:
    runs-on: [x64, qemu-host]
    container:
      image: ghcr.io/viamrobotics/micro-rdk-dev-env:amd64
    needs: tests
    steps:
    - name : Checkout main branch code
      uses: actions/checkout@v3
      with:
        fetch-depth: 2
    - name: Build release image
      run: |
        bash -c 'export MICRO_RDK_USE_NVS=true && . "$IDF_PATH"/export.sh && . "$ESP_ROOT"/export-esp.sh && make build-fake'
    - name: Upload release binary
      uses: marvinpinto/action-automatic-releases@latest
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: esp32-server-with-cred.bin
        prerelease: false
